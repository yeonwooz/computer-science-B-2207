## 메모리 관리

### 가상 메모리

CPU 캐시는 가상메모리를 이용해 데이터에 가상 주소(논리적 주소)를 부여한다.

가상주소는 메모리 관리 장치 (MMU)에 의해 물리적 주소로 변환된다.

논리적 주소와 물리적 주소의 매핑은 RAM안의 페이지 테이블에 저장되고 CPU는 페이지 테이블을 참조하여 데이터를 조회한다.

### TLB

CPU가 페이지테이블에 가기 전에 먼저 들르는 캐시공간. 가장 최근에 MMU에 의해 변환된 결과가 저장되어 있다.

### 스와핑

가상 메모리에는 존재하지만 RAM에는 없는 데이터에 접근하면 페이지 폴트가 발생한다. 이를 방지하기 위해 사용하는 영역과 사용하지 않는 영역을 각각 RAM에 올리고 HDD에 내리는 것을 반복하여 관리하는 것을 스와핑이라고 한다.

### 페이지 폴트(page fault)

가상 주소공간에는 존재하지만 물리 주소공간에는 존재하지 않는 데이터에 접근하는 경우

스와퍼는 사용하는 영역을 물리 메모리에 올릴 때, 이 영역의 모든 프로세스를 전부 올리지는 않는다. (효율적인 메모리 사용을 위해).

그리고 페이저는 프로세스의 모든 페이지를 물리 메모리에 전부 올리지는 않는다.

따라서 프로그램이 실행될 때 특정 페이지가 물리 메모리에 없을 수 있다. 이것이 페이지 폴트이다.

\* 페이지 :가상 메모리의 최소 크기 단위

\* 프레임 :물리 메모리의 최소 크기 단위

### 페이지 폴트가 발생하면

1. CPU는 물리 메모리를 확인하여 트랩을 발생
2. 운영체제는 CPU를 멈춤
3.

- 운영체제는 페이지 테이블을 조회하여 가상 메모리에 페이지가 존재하는지 확인
- 현재 물리 메모리에 비어있는 프레임이 없다면 스와핑 발동

4. 비어있는 프레임에 해당 페이지를 로드하고, 페이지 테이블 최신화
5. CPU 동작 재개

### 스레싱

메모리의 페이지 폴트율이 높은 상황.

페이지 폴트가 자주 일어나면 CPU이용률이 낮아져서, 운영체제가 CPU 가상메모리에 더 많은 프로세스를 올린다. 점차 스와핑이 많이 일어나서 스레싱이 발생한다.

### 스레싱 해결

- HHD vs SSD(SDD)

  - 보조 기억장치. SSD의 처리속도가 더 빠르다. 이전에는 SSD가 훨씬 비쌌지만 최근에는 비슷해졌다.

- 작업 세트

  - 프로세스의 지역성을 통해 결정된 페이지 집합을 만들어서 미리 메모리에 로드하는 것.

- PFF (Page Fault Frequency)
  - 상한선과 하한선을 만들어서, 페이지 개수를 조절하는 것

### 메모리 할당

메모리에 프로그램을 할당할 때는 시작 메모리 위치, 메모리의 할당 크기를 기반으로 할당한다.

1. <b>연속 할당</b> : 메모리에 연속적으로 공간을 할당하는 것.

#### 고정 분할 방식

- 메모리를 미리 나누어 관리하는 방식.
- 융통성이 없다.
- 내부 단편화가 발생할 수 있다.

#### 가변 분할 방식

- 프로그램의 크기에 맞게 매번 동적으로 메모리를 나눠 사용.
- 외부 단편화가 발생할 수 있다.
- 최초적합 / 최적적합 / 최악적합 방식으로 작업을 할당해 나간다.

\* 내부 단편화 : 메모리를 나눈 크기보다 프로그램이 작아서 들어가지 못하는 공간이 많이 발생하는 현상. 발생항 홀은 너무 작아 다른 작업을 할당할 수 없고 낭비된다.

\* 외부 단편화 : 메모리를 나눈 크기보다 프로그램이 커서 들어가지 못하는 공간이 많이 발생하는 현상. 홀이 남아있음에도 너무 작아서 작업을 할당받을 수 없다.

2. <b>불연속 할당</b> : 메모리를 연속적으로 할당하지 않는 방법.

#### 페이징

- 프로세스를 페이지 단위(4KB) 로 나누어 메모리의 서로 다른 위치에 할당한다. 홀의 크기가 균일해지지만 주소 변환이 복잡해진다.
- 각 프로세스는 페이징 테이블을 가지고 있으며, 테이블 한 칸에는 가상 메모리의 페이지 번호와 물리 메모리 상의 프레임이 위치한 시작 주소가 있다.(프레임 번호)

### 세그멘테이션

- 프로세스를 페이지가 아닌 세그먼트 단위로 나눈다. 세그먼트 단위로 나눈다는 것은 코드 영역, 데이터 영역, 스택 영역, 힙 영역을 기준으로 나눈다는 것이다.
- 홀의 크기는 균일하지 않다.
- 공유와 보안 측면에서 좋다.
- 내부 단편화 문제가 해소된다.
- 외부 단편화가 생길 수 있다.

#### 페이지드 세그멘테이션

- 세그멘테이션 테이블에 세그먼트 번호로 먼저 접근하고, 만약 주 메모리에 대한 접근권한이 있다면 페이지의 넘버와 개수를 가져온다. 페이지 넘버로 페이지 테이블에 접근해서 프레임 번호를 가져오고 물리 메모리의 해당 프레임에 접근한다.
- 만약 물리 메모리에 해당 프레임이 없다면 스왑을 통해 물리메모리로 데이터를 가져온다.

### 스와핑 (페이지 교체) 알고리즘

한정된 메모리를 효율적으로 활용하기 위해 데이터가 교체되는 것을 스와핑이라고 한다.
페이지 교체 알고리즘을 기반으로 스와핑이 일어난다.

- 오프라인 알고리즘

  - 먼 미래에 참조되는 페이지와 현재 핟당하는 페이지를 바꾸는 알고리즘. 현실적으로 불가능한 알고리즘이지만 다른 알고리즘의 성능 측정 기준으로 활용되는 알고리즘.

- FIFO

  - 가장 먼저 온 페이지를 가장 먼저 교체하는 방법

- LRU, NRU

  - 참조한지 가장 오래된 페이지를 가장 먼저 교체하는 방법
  - LRU는 각 페이지마다 시간 기억을 하는 계수기를 두고 **참조한 시간** 이 체크되도록 하여 그 값을 보고 현재 시점에서 참조한지 가장 오래된 페이지 교체대상을 선정한다.
  - NUR은 각 페이지마다 **두 개의 비트(참조비트와 변형비트)** 를 구성하여 두 값에 따라 교체대상을 선정한다. 만약 두 비트가 모두 0이면 가장 먼저 교체되는 페이지가 되는 것이고, 두 비트가 모두 1이면 가장 나중에 교체되는 페이지로 판단한다.

- LFU
  - 페이지를 **참조한 횟수**가 가장 낮은 페이지를 가장 먼저 교체하는 방법
